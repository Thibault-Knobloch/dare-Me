<%- include ("includes/header") %>

<section>
    <div id="main-section">
        <div>
            <div>
                <div id="page-contents">
                    <div id="sidebar-container">
                        <%- include ("includes/left-sidebar") %>
                    </div>
                    <div id="newsfeed-container">
                        <div id="add-post-box"></div>
                        <div class="loadMore" id="newsfeed">

                        </div>
                        <div id="autorenew_div">
                            <span onclick="getMoreNewsfeed();" class="material-icons" style="font-size: 30px; color: white;">autorenew</span>
                        <div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<script>

    var isHomePage = true;

    var posts_loaded = 0;

    function doPost(form) {
        var ajax = new XMLHttpRequest();
        ajax.open("POST", "/addPost", true);

        ajax.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);
                alert(response.message);

                if (response.status == "success") {
                    document.getElementById("form-add-post").querySelector("input[name='image']").value = "";
                    document.getElementById("form-add-post").querySelector("input[name='video']").value = "";
                    document.getElementById("form-add-post").querySelector("textarea[name='caption']").value = "";

                    document.getElementById("post-img-preview").style.display = "none";
                    document.getElementById("post-video-preview").style.display = "none";
                    document.getElementById("post-preview-cross").style.display = "none";

                    if (post_dare == true) {
                        document.getElementById("form-add-post").querySelector("input[name='goal']").value = "";
                    } else if (post_dare == false) {
                        document.getElementById("form-add-post").querySelector("input[name='dareID']").value = "";
                        post_dare = true;
                        showAddPost();
                    }
                    
                    showNewsfeed();
                }
            }
        };

        var formData = new FormData(form);
        formData.append("accessToken", localStorage.getItem("accessToken"));

        if (post_dare == true) {
            var dareID = makeDareID();
            formData.append("passed_dareID", dareID);
        }

        ajax.send(formData);
        return false;
    }

    function makeDareID() {
        var result = "";
        var characters       = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        var charactersLength = characters.length;
        for ( var i = 0; i < 6; i++ ) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        
        return result;
    }

    function showNewsfeed() {
        var ajax = new XMLHttpRequest();
        ajax.open("POST", "/getNewsfeed", true);

        ajax.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);

                var html = "";
                if (response.no_posts == true) {
                    posts_loaded = 0;
                
                    document.getElementById("newsfeed").innerHTML = html;
                } else {
                    for (var a = 0; a < response.data.length; a++) {
                    var data = response.data[a];

                    if (data.distinction == "dare") {
                        html += '<div id="postdiv" class="post_div" style="position: relative; max-width: 600px; min-width: 450px;">';

                            html += '<div>';
                                html += '<div class="post_content_div">';
                                    html += '<div class="post_user_div">';
                                        html += '<div class="post_pp_div">';
                                            html += '<figure>';
                                                html += '<img id="post_pp" src="' + mainURL + '/' + data.user.profileImage + '">';
                                            html += '</figure>';
                                        html += '</div>';

                                        html += '<div class="friend-name">';
                                            html += '<ins>';
                                                html += '<a href="/user/' + data.user._id + '">';
                                                    html += data.user.name;
                                                html += '</a>';
                                            html += '</ins>'; 
                                        html += '</div>';
                                            
                                        var createdAt = new Date(data.createdAt);
                                        var date = createdAt.getDate() + "";
                                        date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();
                                        html += '<div id="timestamp">';
                                            html += '<span style="color: rgb(141, 141, 141);">' + date + '</span>';
                                        html += '</div>';

                                        html += '<div class="post_distinction">';
                                            html += '<span id="distinction_text_' + data.dareID + '" style="display: block; color: red; text-align: right; font-size: 18px;">' + data.distinction.toUpperCase();
                                                if (data.bp_now >= data.bp_goal) {
                                                    html += ' ' + data.dare_status.toUpperCase();
                                                }
                                            html += '</span>';
                                            html += '<span style="display: block; text-align: right;">(ID: ' + data.dareID + ')</span>';
                                        html += '</div>';
                                        
                                    html += '</div>';

                                    html += '<div class="post-meta">';

                                        html += '<div class="description">';
                                            html += '<p style="font-size: 16px;">';
                                                html += data.caption;
                                            html += '</p>';
                                        html += '</div>';

                                        if (data.image != "") {
                                            html += '<img class="post_image" src="' + mainURL + '/' + data.image + '">';
                                        }
                                        if (data.video != "") {
                                            html += '<video class="post_video" style="height: 359px; width: 100%;" controls src="' + mainURL + '/' + data.video + '"></video>';
                                        }

                                        html += '<div style="margin-bottom: 40px; margin-top: 10px;">';
                                            if (data.bp_now < data.bp_goal) {
                                                html += '<form method="post" id="submit-dare_' + data.dareID + '" onsubmit="return doDare(this);">';

                                                    html += '<div style="float: left;">';
                                                    html += '<input id="dare_range_input" type="range" name="new_dare" value="1" min="1" max="' + Math.min((Number(data.bp_goal) - Number(data.bp_now)), window.user.blue_points) + '" oninput="this.nextElementSibling.value = this.value">';
                                                    html += '<output id="range_output">1</output>';

                                                    html += '<input type="text" value="' + data.dareID + '" name="dareIDPost" style="display: none;">';

                                                    html += '<button id="post_dare" type="submit">Dare</button>';
                                                html += '</div>';

                                                html += '</form>';
                                            }
                                            

                                            html += '<div id="dare_meta_' + data.dareID + '" style="float: right;" data-id="' + data._id + '" class="dare_meta" onclick="showDareDiv(this);">';
                                                if (data.bp_now >= data.bp_goal) {
                                                    html += '<span style="margin-left: 4px; font-size: 21px;">' + data.bp_goal;
                                                    html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -2px;" src="/public/images/blue_point.png"></span>';
                                                } else {
                                                    html += '<span style="margin-left: 4px; font-size: 21px;">Dared: <span id="dare_bp_now_' + data.dareID + '">' + data.bp_now + ' </span>/ '  + data.bp_goal;
                                                    html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -2px;" src="/public/images/blue_point.png"></span>';
                                                }
                                                
                                            html += '</div>';
                                        html += '</div>';

                                        html += createLikesSection(data);
                                    html += '</div>';
                                html += '</div>';

                                html += createCommentsSection(data);
                            html += '</div>';

                            html += '<div id="dares_list_' + data._id + '" class="dare_list_div" style="display: none;">';
                                html += '<ul style="display: block;">';
                                    if (data.dares.length == 0) {
                                        html += '<li style="color: white; margin-left: -25px;">No dares yet. Be the first one to dare!</li>';
                                    } else {
                                        for (var i = 0; i < data.dares.length; i++) {
                                            var darer = data.dares[i];
                                            html += '<div style="margin-bottom: 15px;">';
                                                html += '<li style="margin-left: -30px; display: flex;">';
                                                    html += '<div style="width: 200px; display: flex;">';
                                                        html += '<div>';
                                                            html += '<img id="dare_pp" src="' + mainURL + '/' + darer.profileImage + '">';
                                                        html += '</div>';

                                                        html += '<div style="margin-top: 8px;">';
                                                            html += '<a style="margin-left: 5px; padding-bottom: 50px;" href="/user/' + darer._id + '">' + darer.name + '</a>';
                                                        html += '</div>';
                                                    html += '</div>';
                                                    
                                                    html += '<div style="display: flex; width: 80px; height: 40px; margin-top: -10px;">';
                                                        html += '<h3 style="margin-bottom: 5px;">' + darer.bp_dared + '</h3>';
                                                        html += '<img style="display: inline; width: 19px; height: 19px; margin-left: 7px; margin-top: 20px; float: right;" src="/public/images/blue_point.png">';
                                                    html += '</div>';
                                                html += '</li>';
                                            html += '</div>';
                                        } 
                                    }
                                html += '</ul>';
                            html += '</div>';

                        html += '</div>';

                    } else if (data.distinction == "completed") {
                        html += '<div id="postdiv" class="post_div" style="position: relative; max-width: 600px; min-width: 450px;">';
                            html += '<div>';
                                html += '<div class="post_content_div">';
                                    html += '<div class="post_user_div">';
                                        html += '<div class="post_pp_div">';
                                            html += '<figure>';
                                                html += '<img id="post_pp" src="' + mainURL + '/' + data.user.profileImage + '">';
                                            html += '</figure>';
                                        html += '</div>';

                                        html += '<div class="friend-name">';
                                            html += '<ins>';
                                                html += '<a href="/user/' + data.user._id + '">';
                                                    html += data.user.name;
                                                html += '</a>';
                                            html += '</ins>'; 
                                        html += '</div>';
                                            
                                        var createdAt = new Date(data.createdAt);
                                        var date = createdAt.getDate() + "";
                                        date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();
                                        html += '<div id="timestamp">';
                                            html += '<span style="color: rgb(141, 141, 141);">' + date + '</span>';
                                        html += '</div>';

                                        html += '<div class="post_distinction">';
                                            html += '<span style="display: block; color: blue; text-align: right; font-size: 18px;">' + data.distinction.toUpperCase() + '</span>';
                                            html += '<span style="display: block; text-align: right;">ID: ' + data.dareID + '</span>';
                                        html += '</div>';
                                        
                                    html += '</div>';

                                    html += '<div class="post-meta">';
                                        html += '<div class="description">';
                                            html += '<p style="font-size: 16px;">';
                                                html += data.caption;
                                            html += '</p>';
                                        html += '</div>';

                                        if (data.image != "") {
                                            html += '<img class="post_image" src="' + mainURL + '/' + data.image + '">';
                                        }
                                        if (data.video != "") {
                                            html += '<video class="post_video" style="height: 359px; width: 100%;" controls src="' + mainURL + '/' + data.video + '"></video>';
                                        }

                                        var didDare = false;

                                        for (var b = 0; b < data.dares.length; b++) {
                                            var darer = data.dares[b];
                                            if (darer._id == window.user._id) {
                                                didDare = true;
                                                break
                                            }
                                        }

                                        var display_accept = "";
                                        var didAccept = false; 
                                        //send this bool with the rejection server call, because cannot press on accept when already in accepted

                                        for (var c = 0; c < data.accepted.length; c++) {
                                            var accept = data.accepted[c];
                                            if (accept._id == window.user._id) {
                                                display_accept = "none";
                                                didAccept = true;
                                                break
                                            }
                                        }

                                        var display_reject = "";
                                        var didReject = false;

                                        for (var d = 0; d < data.rejected.length; d++) {
                                            var reject = data.rejected[d];
                                            if (reject._id == window.user._id) {
                                                display_reject = "none";
                                                didReject = true;
                                                break
                                            }
                                        }

                                        var showButtons = true;
                                        if (data.dare_accepted == true || data.dare_rejected == true) {
                                            showButtons = false;
                                        }

                                        html += '<div id="completed_meta_div_' + data.dareID + '" style="margin-bottom: 40px; margin-top: 10px;">';
                                            if ((didDare == true) && (showButtons == true)) {
                                                html += '<form id="voteForm_ ' + data.dareID + '">';
                                                    html += '<div style="float: left;">';
                                                        html += '<button type="button" data-bool="' + didReject + '" style="display: ' + display_accept + ';" onclick="voteAccepted(this);" data-id="' + data.dareID + '">Accept</button>';
                                                        html += '<button type="button" data-bool="' + didAccept + '" style="display: ' + display_reject + '; margin-left: 5px;" onclick="voteRejected(this);" data-id="' + data.dareID + '">Reject</button>';
                                                        html += '<span id="meta_completed_' + data.dareID + '" style="margin-left: 10px;">' + data.accepted.length + '/'+ data.dare_users + '</span>';
                                                    html += '</div>';
                                                html += '</form>';
                                            } else {
                                                if (data.dare_accepted == true) {
                                                    html += '<div style="float: left;">';
                                                        html += '<span style="float: left; color: green;">DARE ACCEPTED</span>';
                                                    html += '</div>';
                                                } else if (data.dare_rejected == true) {
                                                    html += '<div style="float: left;">';
                                                        html += '<span style="float: left; color: red;">DARE REJECTED</span>';
                                                    html += '</div>';
                                                } else {
                                                    html += '<div style="float: left;">';
                                                        html += '<span>CANNOT VOTE</span>';
                                                    html += '</div>';
                                                }
                                            }
                                            html += '<div style="float:right;" data-id="' + data._id + '" class="dare_meta" onclick="showDareDiv(this);">';
                                                html += '<span style="margin-left: 4px; font-size: 21px;">' + data.bp_goal;
                                                html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -5px;" src="/public/images/blue_point.png"></span>';
                                            html += '</div>';

                                        html += '</div>';

                                        html += createLikesSection(data);
                                    html += '</div>';
                                html += '</div>';

                                html += createCommentsSection(data);
                            html += '</div>';

                            html += '<div id="dares_list_' + data._id + '" class="dare_list_div" style="display: none;">';
                                html += '<ul style="display: block;">';
                                    if (data.dares.length == 0) {
                                        html += '<li style="color: white; margin-left: -25px;">No dares yet. Be the first one to dare!</li>';
                                    } else {
                                        for (var i = 0; i < data.dares.length; i++) {
                                            var darer = data.dares[i];
                                            html += '<div style="margin-bottom: 15px;">';
                                                html += '<li style="margin-left: -30px; display: flex;">';
                                                    html += '<div style="width: 200px; display: flex;">';
                                                        html += '<div>';
                                                            html += '<img id="dare_pp" src="' + mainURL + '/' + darer.profileImage + '">';
                                                        html += '</div>';

                                                        html += '<div style="margin-top: 8px;">';
                                                            html += '<a style="margin-left: 5px; padding-bottom: 50px;" href="/user/' + darer._id + '">' + darer.name + '</a>';
                                                        html += '</div>';
                                                    html += '</div>';
                                                    
                                                    html += '<div style="display: flex; width: 80px; height: 40px; margin-top: -10px;">';
                                                        html += '<h3>' + darer.bp_dared + '</h3>';
                                                        html += '<img style="width: 19px; height: 19px; margin-left: 5px; margin-top: 18px;" src="/public/images/blue_point.png">';
                                                    html += '</div>';
                                                html += '</li>';
                                            html += '</div>';
                                        } 
                                    }
                                html += '</ul>';
                            html += '</div>';

                        html += '</div>';

                    }    
                }

                posts_loaded = response.data.length;
                
                document.getElementById("newsfeed").innerHTML = html;
                }
                
            }
        };

        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        ajax.send(formData);
    }

    function getMoreNewsfeed() {
        var ajax = new XMLHttpRequest();
        ajax.open("POST", "/getMorePosts", true);

        ajax.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);

                var html = "";

                if (response.data == "empty") {
                    html += '<span>No more posts to be loaded</span>';
                    document.getElementById("autorenew_div").innerHTML = html;
                } else {
                    for (var a = posts_loaded; a < response.data.length; a++) {
                    var data = response.data[a];
                    
                    if (data.distinction == "dare") {
                        html += '<div id="postdiv" class="post_div" style="position: relative; max-width: 600px; min-width: 450px;">';

                            html += '<div>';
                                html += '<div class="post_content_div">';
                                    html += '<div class="post_user_div">';
                                        html += '<div class="post_pp_div">';
                                            html += '<figure>';
                                                html += '<img id="post_pp" src="' + mainURL + '/' + data.user.profileImage + '">';
                                            html += '</figure>';
                                        html += '</div>';

                                        html += '<div class="friend-name">';
                                            html += '<ins>';
                                                html += '<a href="/user/' + data.user._id + '">';
                                                    html += data.user.name;
                                                html += '</a>';
                                            html += '</ins>'; 
                                        html += '</div>';
                                            
                                        var createdAt = new Date(data.createdAt);
                                        var date = createdAt.getDate() + "";
                                        date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();
                                        html += '<div id="timestamp">';
                                            html += '<span style="color: rgb(141, 141, 141);">' + date + '</span>';
                                        html += '</div>';

                                        html += '<div class="post_distinction">';
                                            html += '<span id="distinction_text_' + data.dareID + '" style="display: block; color: red; text-align: right; font-size: 18px;">' + data.distinction.toUpperCase();
                                                if (data.bp_now >= data.bp_goal) {
                                                    html += ' ' + data.dare_status.toUpperCase();
                                                }
                                            html += '</span>';
                                            html += '<span style="display: block; text-align: right;">(ID: ' + data.dareID + ')</span>';
                                        html += '</div>';
                                        
                                    html += '</div>';

                                    html += '<div class="post-meta">';

                                        html += '<div class="description">';
                                            html += '<p style="font-size: 16px;">';
                                                html += data.caption;
                                            html += '</p>';
                                        html += '</div>';

                                        if (data.image != "") {
                                            html += '<img class="post_image" src="' + mainURL + '/' + data.image + '">';
                                        }
                                        if (data.video != "") {
                                            html += '<video class="post_video" style="height: 359px; width: 100%;" controls src="' + mainURL + '/' + data.video + '"></video>';
                                        }

                                        html += '<div style="margin-bottom: 40px; margin-top: 10px;">';
                                            if (data.bp_now < data.bp_goal) {
                                                html += '<form method="post" id="submit-dare_' + data.dareID + '" onsubmit="return doDare(this);">';

                                                    html += '<div style="float: left;">';
                                                    html += '<input id="dare_range_input" type="range" name="new_dare" value="1" min="1" max="' + Math.min((Number(data.bp_goal) - Number(data.bp_now)), window.user.blue_points) + '" oninput="this.nextElementSibling.value = this.value">';
                                                    html += '<output id="range_output">1</output>';

                                                    html += '<input type="text" value="' + data.dareID + '" name="dareIDPost" style="display: none;">';

                                                    html += '<button id="post_dare" type="submit">Dare</button>';
                                                html += '</div>';

                                                html += '</form>';
                                            }
                                            

                                            html += '<div id="dare_meta_' + data.dareID + '" style="float: right;" data-id="' + data._id + '" class="dare_meta" onclick="showDareDiv(this);">';
                                                if (data.bp_now >= data.bp_goal) {
                                                    html += '<span style="margin-left: 4px; font-size: 21px;">' + data.bp_goal;
                                                    html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -2px;" src="/public/images/blue_point.png"></span>';
                                                } else {
                                                    html += '<span style="margin-left: 4px; font-size: 21px;">Dared: <span id="dare_bp_now_' + data.dareID + '">' + data.bp_now + ' </span>/ '  + data.bp_goal;
                                                    html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -2px;" src="/public/images/blue_point.png"></span>';
                                                }
                                                
                                            html += '</div>';
                                        html += '</div>';

                                        html += createLikesSection(data);
                                    html += '</div>';
                                html += '</div>';

                                html += createCommentsSection(data);
                            html += '</div>';

                            html += '<div id="dares_list_' + data._id + '" class="dare_list_div" style="display: none;">';
                                html += '<ul style="display: block;">';
                                    if (data.dares.length == 0) {
                                        html += '<li style="color: white; margin-left: -25px;">No dares yet. Be the first one to dare!</li>';
                                    } else {
                                        for (var i = 0; i < data.dares.length; i++) {
                                            var darer = data.dares[i];
                                            html += '<div style="margin-bottom: 15px;">';
                                                html += '<li style="margin-left: -30px; display: flex;">';
                                                    html += '<div style="width: 200px; display: flex;">';
                                                        html += '<div>';
                                                            html += '<img id="dare_pp" src="' + mainURL + '/' + darer.profileImage + '">';
                                                        html += '</div>';

                                                        html += '<div style="margin-top: 8px;">';
                                                            html += '<a style="margin-left: 5px; padding-bottom: 50px;" href="/user/' + darer._id + '">' + darer.name + '</a>';
                                                        html += '</div>';
                                                    html += '</div>';
                                                    
                                                    html += '<div style="display: flex; width: 80px; height: 40px; margin-top: -10px;">';
                                                        html += '<h3 style="margin-bottom: 5px;">' + darer.bp_dared + '</h3>';
                                                        html += '<img style="width: 19px; height: 19px; margin-left: 7px; margin-top: 20px;" src="/public/images/blue_point.png">';
                                                    html += '</div>';
                                                html += '</li>';
                                            html += '</div>';
                                        } 
                                    }
                                html += '</ul>';
                            html += '</div>';

                        html += '</div>';

                    } else if (data.distinction == "completed") {
                        html += '<div id="postdiv" class="post_div" style="position: relative; max-width: 600px; min-width: 450px;">';
                            html += '<div>';
                                html += '<div class="post_content_div">';
                                    html += '<div class="post_user_div">';
                                        html += '<div class="post_pp_div">';
                                            html += '<figure>';
                                                html += '<img id="post_pp" src="' + mainURL + '/' + data.user.profileImage + '">';
                                            html += '</figure>';
                                        html += '</div>';

                                        html += '<div class="friend-name">';
                                            html += '<ins>';
                                                html += '<a href="/user/' + data.user._id + '">';
                                                    html += data.user.name;
                                                html += '</a>';
                                            html += '</ins>'; 
                                        html += '</div>';
                                            
                                        var createdAt = new Date(data.createdAt);
                                        var date = createdAt.getDate() + "";
                                        date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();
                                        html += '<div id="timestamp">';
                                            html += '<span style="color: rgb(141, 141, 141);">' + date + '</span>';
                                        html += '</div>';

                                        html += '<div class="post_distinction">';
                                            html += '<span style="display: block; color: blue; text-align: right; font-size: 18px;">' + data.distinction.toUpperCase() + '</span>';
                                            html += '<span style="display: block; text-align: right;">ID: ' + data.dareID + '</span>';
                                        html += '</div>';
                                        
                                    html += '</div>';

                                    html += '<div class="post-meta">';
                                        html += '<div class="description">';
                                            html += '<p style="font-size: 16px;">';
                                                html += data.caption;
                                            html += '</p>';
                                        html += '</div>';

                                        if (data.image != "") {
                                            html += '<img class="post_image" src="' + mainURL + '/' + data.image + '">';
                                        }
                                        if (data.video != "") {
                                            html += '<video class="post_video" style="height: 359px; width: 100%;" controls src="' + mainURL + '/' + data.video + '"></video>';
                                        }

                                        var didDare = false;

                                        for (var b = 0; b < data.dares.length; b++) {
                                            var darer = data.dares[b];
                                            if (darer._id == window.user._id) {
                                                didDare = true;
                                                break
                                            }
                                        }

                                        var display_accept = "";
                                        var didAccept = false; 
                                        //send this bool with the rejection server call, because cannot press on accept when already in accepted

                                        for (var c = 0; c < data.accepted.length; c++) {
                                            var accept = data.accepted[c];
                                            if (accept._id == window.user._id) {
                                                display_accept = "none";
                                                didAccept = true;
                                                break
                                            }
                                        }

                                        var display_reject = "";
                                        var didReject = false;

                                        for (var d = 0; d < data.rejected.length; d++) {
                                            var reject = data.rejected[d];
                                            if (reject._id == window.user._id) {
                                                display_reject = "none";
                                                didReject = true;
                                                break
                                            }
                                        }

                                        var showButtons = true;
                                        if (data.dare_accepted == true || data.dare_rejected == true) {
                                            showButtons = false;
                                        }

                                        html += '<div id="completed_meta_div_' + data.dareID + '" style="margin-bottom: 40px; margin-top: 10px;">';
                                            if ((didDare == true) && (showButtons == true)) {
                                                html += '<form id="voteForm_ ' + data.dareID + '">';
                                                    html += '<div style="float: left;">';
                                                        html += '<button type="button" data-bool="' + didReject + '" style="display: ' + display_accept + ';" onclick="voteAccepted(this);" data-id="' + data.dareID + '">Accept</button>';
                                                        html += '<button type="button" data-bool="' + didAccept + '" style="display: ' + display_reject + '; margin-left: 5px;" onclick="voteRejected(this);" data-id="' + data.dareID + '">Reject</button>';
                                                        html += '<span id="meta_completed_' + data.dareID + '" style="margin-left: 10px;">' + data.accepted.length + '/'+ data.dare_users + '</span>';
                                                    html += '</div>';
                                                html += '</form>';
                                            } else {
                                                if (data.dare_accepted == true) {
                                                    html += '<div style="float: left;">';
                                                        html += '<span style="float: left; color: green;">DARE ACCEPTED</span>';
                                                    html += '</div>';
                                                } else if (data.dare_rejected == true) {
                                                    html += '<div style="float: left;">';
                                                        html += '<span style="float: left; color: red;">DARE REJECTED</span>';
                                                    html += '</div>';
                                                } else {
                                                    html += '<div style="float: left;">';
                                                        html += '<span>CANNOT VOTE</span>';
                                                    html += '</div>';
                                                }
                                            }
                                            html += '<div style="float:right;" data-id="' + data._id + '" class="dare_meta" onclick="showDareDiv(this);">';
                                                html += '<span style="margin-left: 4px; font-size: 21px;">' + data.bp_goal;
                                                html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -5px;" src="/public/images/blue_point.png"></span>';
                                            html += '</div>';

                                        html += '</div>';

                                        html += createLikesSection(data);
                                    html += '</div>';
                                html += '</div>';

                                html += createCommentsSection(data);
                            html += '</div>';

                            html += '<div id="dares_list_' + data._id + '" class="dare_list_div" style="display: none;">';
                                html += '<ul style="display: block;">';
                                    if (data.dares.length == 0) {
                                        html += '<li style="color: white; margin-left: -25px;">No dares yet. Be the first one to dare!</li>';
                                    } else {
                                        for (var i = 0; i < data.dares.length; i++) {
                                            var darer = data.dares[i];
                                            html += '<div style="margin-bottom: 15px;">';
                                                html += '<li style="margin-left: -30px; display: flex;">';
                                                    html += '<div style="width: 200px; display: flex;">';
                                                        html += '<div>';
                                                            html += '<img id="dare_pp" src="' + mainURL + '/' + darer.profileImage + '">';
                                                        html += '</div>';

                                                        html += '<div style="margin-top: 8px;">';
                                                            html += '<a style="margin-left: 5px; padding-bottom: 50px;" href="/user/' + darer._id + '">' + darer.name + '</a>';
                                                        html += '</div>';
                                                    html += '</div>';
                                                    
                                                    html += '<div style="display: flex; width: 80px; height: 40px; margin-top: -10px;">';
                                                        html += '<h3>' + darer.bp_dared + '</h3>';
                                                        html += '<img style="width: 19px; height: 19px; margin-left: 5px; margin-top: 18px;" src="/public/images/blue_point.png">';
                                                    html += '</div>';
                                                html += '</li>';
                                            html += '</div>';
                                        } 
                                    }
                                html += '</ul>';
                            html += '</div>';

                        html += '</div>';

                    }    
                } // end for loop

                posts_loaded += (response.data.length - posts_loaded);
                document.getElementById("newsfeed").insertAdjacentHTML('beforeend', html);
                }
            }
                
        };

        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("posts_loaded", posts_loaded);
        ajax.send(formData);
    }

    function doDare(form) {
        
        var ajax = new XMLHttpRequest();
        ajax.open("POST", "/addDare", true);


        ajax.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);
                alert(response.message);

                if (response.status == "success") {
                    bp_now_current_dare = "dare_bp_now_" + response.dareID;
                    document.getElementById(bp_now_current_dare).innerHTML = Number(response.bp_current);
                    document.getElementById("dare_range_input").value = 1;
                    document.getElementById("range_output").innerHTML = 1;
                    
                    if (response.dare_status == "closed") {
                        var html = "";

                        html += '<span style="margin-left: 4px; font-size: 21px;">' + response.bp_goal;
                        html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -2px;" src="/public/images/blue_point.png"></span>';
                        
                        var meta_id = "dare_meta_" + response.dareID;
                        document.getElementById(meta_id).innerHTML = html;

                        var distinction_id = "distinction_text_" + response.dareID;
                        document.getElementById(distinction_id).insertAdjacentHTML('beforeend', " READY");

                        var form_id = "submit-dare_" + response.dareID;
                        document.getElementById(form_id).style.display = "none";

                        // this does not work
                        var dare_list_div = "dares_list_" + response.dare._id;
                        var html2 = "BABABA";
                        
                        document.getElementById(dare_list_div).innerHTML = html2;
                    }
                }
            }
        };

        var formData = new FormData(form);
        formData.append("accessToken", localStorage.getItem("accessToken"));
        
        ajax.send(formData);
        return false;

    }

    function voteAccepted(self) {
        
        var dareID = self.getAttribute("data-id");
        var didReject = self.getAttribute("data-bool");

        var ajax = new XMLHttpRequest();
        ajax.open("POST", "/dareAccepted", true);

        ajax.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);
                alert(response.message);
                alert(response.completed_status);

                if (response.status == "success") {
                    var element_id = "meta_completed_" + dareID;
                    document.getElementById(element_id).innerHTML = response.data.accepted.length + "/" + response.data.dare_users;

                    if (response.completed_status == "accepted") {
                        var div_id = "completed_meta_div_" + dareID;
                        html = ""
                        html += '<div style="float:right;" data-id="' + response.data._id + '" class="dare_meta" onclick="showDareDiv(this);">';
                            html += '<span style="margin-left: 4px; font-size: 21px;">' + response.data.bp_goal;
                            html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -5px;" src="/public/images/blue_point.png"></span>';
                        html += '</div>';
                        document.getElementById(div_id).innerHTML = '<span style="float: left; color: green;">DARE ACCEPTED</span>' + html;
                        
                        var distinction_id = "distinction_text_" + dareID;
                        document.getElementById(distinction_id).innerHTML = "DARE ACCEPTED";
                    }
                }
            }
        };

        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("dareID", dareID);
        formData.append("didReject", didReject);
        ajax.send(formData);
        
    }

    function voteRejected(self) {
        
        var dareID = self.getAttribute("data-id");
        var didAccept = self.getAttribute("data-bool");

        var ajax = new XMLHttpRequest();
        ajax.open("POST", "/dareRejected", true);

        ajax.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);
                alert(response.message);

                if (response.status == "success") {
                    var element_id = "meta_completed_" + dareID;
                    document.getElementById(element_id).innerHTML = response.data.accepted.length + "/" + response.data.dare_users;

                    if (response.completed_status == "rejected") {
                        var div_id = "completed_meta_div_" + dareID;
                        html = ""
                        html += '<div style="float:right;" data-id="' + response.data._id + '" class="dare_meta" onclick="showDareDiv(this);">';
                            html += '<span style="margin-left: 4px; font-size: 21px;">' + response.data.bp_goal;
                            html += '<img style="width: 19px; margin-left: 7px; margin-bottom: -5px;" src="/public/images/blue_point.png"></span>';
                        html += '</div>';
                        document.getElementById(div_id).innerHTML = '<span style="float: left; color: red;">DARE REJECTED</span>' + html;

                        var distinction_id = "distinction_text_" + dareID;
                        document.getElementById(distinction_id).innerHTML = "DARE REJECTED";
                    }
                }
            }
        };

        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("dareID", dareID);
        formData.append("didAccept", didAccept);
        ajax.send(formData);

    }


</script>


<%- include ("includes/footer") %>